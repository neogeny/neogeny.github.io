AJS.toInit(function(D){var A;var F=function(){A=new AJS.Dialog(860,530,"view-diff-draft-dialog");var H=AJS.params.draftHeading;A.addHeader(H.replace(/\{0\}/,""));var G=D("#draft-changes-dialog");A.addPanel("Diff",G);A.addButton(AJS.params.resumeDraft,function(I){A.hide();if(AJS.Editor){AJS.Editor.sendFormDraft("useDraft")}else{window.location=D(this).attr("data-href")}},"resume-diff-link");A.addButton(AJS.params.mergeDraft,function(I){A.hide();window.parent.location=D(this).attr("data-href")},"merge-diff-link");A.addButton(AJS.params.discardDraft,function(I){A.hide();if(AJS.Editor){AJS.Editor.sendFormDraft("discardDraft")}else{window.location=D(this).attr("data-href")}},"discard-diff-link");A.addButton("Close",function(){A.hide()},"close");G.removeClass("hidden")};var C=function(K,I){var H=function(Q){if(!Q.numChanges){return AJS.params.draftNoChanges}var P="";var M=Q.chunks;var O=M.length;for(var N=0;N<O;N++){P+=M[N].text}return P};D("#diff-view").html(H(K));var L=AJS.params.draftHeading;A.addHeader(L.replace(/\{0\}/,K.title));var J=D("#atlassian-token").attr("content");var G=AJS.General.getContextPath();D(".merge-diff-link").attr("data-href",G+"/pages/resumedraft.action?draftId="+I);D(".resume-diff-link").attr("data-href",G+"/pages/resumedraft.action?draftId="+I);D(".discard-diff-link").attr("data-href",G+"/users/deletedraft.action?draftId="+I+"&atl_token="+J);AJS.setVisible("#merge-warning",K.isMergeRequired);AJS.setVisible(".merge-diff-link",K.isMergeRequired);AJS.setVisible(".resume-diff-link",!K.isMergeRequired)};var E=function(I){var G,K,H;var J=function(M){var L=/draftPageId:([^ ]*)/.exec(M);G=L?L[1]:AJS.params.pageId;L=/username:([^ ]*)/.exec(M);K=L?L[1]:AJS.params.remoteUser;L=/draftId:([^ ]*)/.exec(M);H=L?L[1]:null};J(I.attr("class"));AJS.safeAjax({url:AJS.General.getContextPath()+"/draftchanges/viewdraftchanges.action",type:"GET",dataType:"json",data:{pageId:G,username:K},success:function(N){if(N.actionErrors){var M="";var O=N.actionErrors;for(var L=0;L<O.length;L++){AJS.log("error: "+(O[L]));M=M+"<div>"+O[L]+"</div>"}D("#diff-view").html(M)}else{C(N,H)}},error:function(L){var M=L.errors||"An unknown error has occurred. Please check your logs";D("#diff-view").html(M)}})};var B=function(H,G){if(AJS.Editor){AJS.Editor.saveDraft(false)}if(!A){F()}A.addHeader(AJS.params.loadingHeading);D("#diff-view").html("<tr><td id='draft-changes-waiting-icon'>Loading...</td></tr>");AJS.setVisible("#diff-links",G);E(H);A.show()};D("#draft-status").click(function(H){var G=D(H.target);if(G.hasClass("view-diff-link")){B(G,false)}return AJS.stopEvent(H)});D(".view-diff-link").click(function(H){var G=D(this);B(G,true);return AJS.stopEvent(H)})});