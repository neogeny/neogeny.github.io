jQuery(function(B){function A(C){return B("script[title='"+C+"']")[0].text}B("#manage-watchers-menu-item").click(function(H){H.preventDefault();var D="manage-watchers-dialog";var I=new AJS.ConfluenceDialog({width:865,height:530,id:D,onCancel:function(){I.hide().remove()}});I.addHeader(AJS.I18n.getText("manage.watchers.dialog.title"));I.addPanel("default",AJS.template.load(D).toString());I.addButton("Done",function(){I.hide().remove()});I.show();var E=B("#"+D);E.find(".dialog-button-panel").append(AJS.template.load("manage-watchers-help-link").toString());E.find("input:visible, button:visible").each(function(M){B(this).attr("tabindex",M+1)});AJS.applySearchPlaceholders(E);E.bind("remove-list-item.manage-watchers",function(P,O){var M=O.item,N=O.list,Q=O.username;M.addClass("removing");AJS.safe.ajax({dataType:"json",type:"POST",url:AJS.params.contextPath+"/json/removewatch.action",data:{pageId:AJS.params.pageId,username:Q},error:function(){alert(AJS.I18n.getText("manage.watchers.unable.to.remove.error"));M.removeClass("removing")},success:function(){M.slideUp().remove();E.trigger("list-updated.manage-watchers",{list:N})}})});E.bind("list-updated.manage-watchers",function(P,O){var N=O.list;var M=B("li.watch-user",N).length>0;if(!M){N.find(".no-users").removeClass("hidden");return }N.find(".no-users").addClass("hidden");AJS.Confluence.Binder.userHover();N.find(".confluence-userlink").each(function(){B(this).click(function(Q){Q.preventDefault()})})});E.bind("list-data-retrieved.manage-watchers",function(P,O){var N=O.list,M=O.watchers;N.find(".watch-user").remove();if(M&&M.length){B.each(M,function(){var S=this.name;var R={username:S,fullName:this.fullName,url:AJS.params.contextPath+"/display/~"+this.name,iconUrl:AJS.params.contextPath+this.profilePictureDownloadPath};var Q=B(AJS.template(A("manage-watchers-user")).fill(R).toString());N.append(Q);Q.find(".remove-watch").click(function(){E.trigger("remove-list-item.manage-watchers",{username:S,item:Q,list:N})})})}N.find(".loading").hide();E.trigger("list-updated.manage-watchers",{list:N})});var F=E.find(".page-watchers .user-list");var K=E.find(".space-watchers .user-list");AJS.safe.ajax({url:AJS.params.contextPath+"/json/listwatchers.action",dataType:"json",data:{pageId:AJS.params.pageId},error:function(){alert("Failed to retrieve watchers.")},success:function(M){E.trigger("list-data-retrieved.manage-watchers",{list:F,watchers:M.pageWatchers});E.trigger("list-data-retrieved.manage-watchers",{list:K,watchers:M.spaceWatchers})}});var L=E.find("form");var J=L.find("#add-watcher-user");var C=L.find("#add-watcher-username");var G=(function(){var M=L.find("> .status");return{clear:function(){M.addClass("hidden").removeClass("loading error").text("")},loading:function(N){M.addClass("loading").removeClass("hidden error").html(N)},error:function(N){M.addClass("error").removeClass("hidden loading").text(N)}}})();L.ajaxForm({beforeSerialize:function(){if(C.val()==""){C.val(J.val())}},beforeSubmit:function(){J.blur().attr("disabled","disabled");F.addClass("updating");G.loading(AJS.I18n.getText("manage.watchers.status.adding.watcher"))},dataType:"json",error:function(N,M){alert("Failed to add watcher: "+M)},success:function(M){C.val("");J.attr("disabled","").val("").focus();F.removeClass("updating");if(M.actionErrors&&M.actionErrors.length){G.error(M.actionErrors[0]);return }E.trigger("list-data-retrieved.manage-watchers",{list:F,watchers:M.pageWatchers});G.clear()}});AJS.Confluence.Binder.autocompleteUser();J.bind("selected.autocomplete-user",function(N,M){L.submit()});return false})});