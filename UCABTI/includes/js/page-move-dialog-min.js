AJS.toInit(function(C){var D=function(T){T=C.extend({spaceKey:AJS.params.spaceKey,spaceName:AJS.params.spaceName,parentPageTitle:AJS.params.parentPageTitle,title:AJS.params.movePageDialogViewPageTitle,buttonName:AJS.params.movePageDialogMoveButton,moveHandler:function(U){AJS.log("No move handler defined. Closing dialog.");U.remove()},cancelHandler:function(U){U.remove()},pageTitleAccessor:function(){return AJS.params.pageTitle}},T);var S={spaceKey:T.spaceKey,spaceName:T.spaceName,parentPageTitle:T.parentPageTitle};var O=T.spaceKey;var H=T.spaceName;var P=T.parentPageTitle;var Q="";var K="";var E=function(U,V){Q=U;K=V};var I=AJS.ConfluenceDialog({width:800,height:590,id:"move-page-dialog"});I.addHeader(T.title);I.addPanel(AJS.params.movePageDialogLocationPanel,AJS.renderTemplate("movePageDialog"),"location-panel","location-panel-id");I.addPanel(AJS.params.movePageDialogSearchPanel,AJS.renderTemplate("movePageSearchPanel"),"search-panel","search-panel-id");I.addPanel(AJS.params.movePageDialogHistoryPanel,AJS.renderTemplate("movePageHistoryPanel"),"history-panel","history-panel-id");I.addPanel(AJS.params.movePageDialogBrowsePanel,AJS.renderTemplate("movePageBrowsePanel"),"browse-panel","browse-panel-id");I.get("panel:0")[0].onselect=function(){C("#new-space-key").val(O);C("#new-space").val(H);C("#new-parent-page").val(P).select()};I.get("panel:1")[0].onselect=function(){C("#move-page-dialog .search-panel .search-results .selected").removeClass("selected");C("#move-page-dialog input.search-query").focus()};I.get("panel:0").select();gotoReorderPage=function(V){V.nextPage();var U=C("#move-page-dialog");C(".ordering-panel",U).movePageOrdering(O,P,T.pageTitleAccessor(),E)};moveFunction=function(V){var X=C("#new-space:visible").val();var W=C("#new-space-key").val();var U=C("#new-parent-page:visible").val();if(X&&(X!=H||W!=O||U!=P)){AJS.MoveDialog.getBreadcrumbs({spaceKey:W,pageTitle:U},function(){T.moveHandler(V,W,X,U,Q,K,M)},function(Y){C("#new-parent-breadcrumbs").html(AJS.renderTemplate("movePageBreadcrumbError"));if(Y.status==404){R.error(AJS.params.movePageDialogLocationNotFound)}})}else{T.moveHandler(V,O,H,P,Q,K,M)}};executeMove=function(U){if(C("#reorderCheck")[0].checked){gotoReorderPage(U)}else{moveFunction(U)}};I.addButton(T.buttonName,executeMove,"move-button");I.addButton(AJS.params.movePageDialogCancelButton,T.cancelHandler,"move-cancel-button");I.popup.element.find(".dialog-button-panel").append(AJS.renderTemplate("move-help-link"));I.addPage();I.page[1].addHeader(T.title);I.page[1].addPanel(AJS.params.movePageDialogOrderingTitle,AJS.renderTemplate("orderingPagePanel"),"ordering-panel","ordering-panel-id");I.page[1].addButton(AJS.params.movePageDialogBackButton,function(U){U.prevPage()},"back left");I.page[1].addButton(AJS.params.movePageDialogMoveAndOrderButton,moveFunction,"reorder-button");I.page[1].addButton(AJS.params.movePageDialogCancelButton,T.cancelHandler,"move-cancel-button");var G=I.get("button#"+T.buttonName)[0].item;C("button.move-button").before(AJS.renderTemplate("reorderCheckbox"));I.gotoPage(0);I.show();var N=C("#move-page-dialog");C(".location-panel .location-info",N).appendTo(C(".dialog-page-body:first",N));C(".dialog-button-panel:visible",N).prepend(AJS.renderTemplate("movePageErrors"));var F=new AJS.MoveDialog.Breadcrumbs(C("#new-parent-breadcrumbs"));function M(U){if(!U||U.length==0){C("#move-errors").addClass("hidden");C(G).attr("disabled","");return }if(!C.isArray(U)){U=[U]}C("#move-errors").text(U[0]).attr("title",U.join("\n")).removeClass("hidden");I.gotoPage(0)}var R={moveButton:G,clearErrors:function(){M([])},error:M,select:function(W,V,U){AJS.log("select: "+[W,V,U].join());O=W;H=V;P=U||"";C(G).attr("disabled","disabled");F.update({spaceKey:O,title:P},R)}};var J=AJS.params.parentPageTitle!=""?AJS.params.parentPageTitle:AJS.params.fromPageTitle;var L=new AJS.MoveDialog.Breadcrumbs(C("#current-parent-breadcrumbs"));L.update({spaceKey:AJS.params.spaceKey,title:J},R);C(".location-panel",N).movePageLocation(R);C(".search-panel",N).movePageSearch(R);C(".history-panel",N).movePageHistory(R);I.get("panel:2")[0].onselect=function(){C(".history-panel",N).movePageHistory(R)};I.get("panel:3")[0].onselect=function(){AJS.log("browse: "+[O,H,P].join());C(".browse-panel",N).movePageBrowse(R,O,H,P,J,T.pageTitleAccessor())};C("#new-parent-page").select();return N};var B=function(G,F,H,E){var I={pageId:AJS.params.pageId,spaceKey:G};if(H){I.position=E;I.targetId=H}else{if(F!=""){I.targetTitle=F;I.position="append"}else{I.position="topLevel"}}return I};function A(I,K,E,L,N,F,H){I=I.popup.element;I.addClass("waiting");C("button",I).attr("disabled","disabled");var G=C("<div class='throbber'></div>");I.append(G);var M=Raphael.spinner(G[0],100,"#666");function J(O){H(O);I.removeClass("waiting");M();C("button",I).attr("disabled","")}C.ajax({url:contextPath+"/pages/movepage.action",type:"GET",dataType:"json",data:new B(K,L,N,F),error:function(){J(AJS.params.movePageDialogMoveFailed)},success:function(O){var P=[].concat(O.validationErrors||[]).concat(O.actionErrors||[]).concat(O.errorMessage||[]);if(P.length>0){J(P);return }window.location.href=contextPath+O.page.url+(O.page.url.indexOf("?")>=0?"&":"?")+"moved=true"}})}C("#action-move-page-dialog-link").click(function(E){E.preventDefault();if(C("#move-page-dialog").length>0){C("#move-page-dialog, body > .shadow, body > .aui-blanket").remove()}new D({moveHandler:A});return false});C("#edit-move-page-dialog-link").click(function(E){E.preventDefault();if(C("#move-page-dialog").length>0){C("#move-page-dialog, body > .shadow, body > .aui-blanket").remove()}new D({spaceKey:C("#newSpaceKey").val(),spaceName:C("#space_content").text(),parentPageTitle:C("#parentPageString").val(),buttonName:AJS.params.movePageDialogOkButton,title:AJS.params.movePageDialogEditPageTitle,moveHandler:function(J,G,K,L,I,H,F){C("#space_content").text(K);C("#newSpaceKey").val(G);C("#parentPageString").val(L);C("#parent_content").text(L);if(L!=""){C("#position").val("append");C("#parent_info").removeClass("hidden")}else{C("#parent_info").addClass("hidden");C("#position").val("topLevel")}if(I){C("#targetId").val(I);C("#position").val(H)}J.remove()},pageTitleAccessor:function(){return C("#content-title").val()}});return false})});