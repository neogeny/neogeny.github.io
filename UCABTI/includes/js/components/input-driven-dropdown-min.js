(function(E){var D=function(G){AJS.log("InputDrivenDropDown: truncating text");var I=G.$.closest(".aui-dd-parent").width(),H=20;E("a span:not(.icon)",G.$).each(function(){var K=E(this),J=AJS("var","&#8230;"),M=J.width(),L=false;K.wrapInner(E("<em>"));E("em",K).each(function(){var N=E(this);N.show();if(this.offsetLeft+this.offsetWidth+M>I-H){var U=this.childNodes,T=false;for(var P=U.length-1;P>=0;P--){var Q=U[P],O=1,S=(Q.nodeType==3)?"nodeValue":"innerHTML",R=Q[S];do{if(O<=R.length){Q[S]=R.substr(0,R.length-O++)}else{break}}while(this.offsetLeft+this.offsetWidth+M>I-H);if(O<=R.length){T=true;break}}if(T){L=true}else{N.hide()}}});if(L){K.append(J);this.elpss=J}})};var B=function(G,L){if(!L.length||!L[0]){return }AJS.log("InputDrivenDropDown: highlighting tokens");for(var I=0,J=L.length;I<J;I++){var H=L[I];L[I]=H?H.replace(/[\.\*\+\?\|\(\)\[\]{}\\]/g,"\\$"):""}var K=new RegExp("("+L.join("|")+")","gi");E("li a:not(.dropdown-prevent-highlight) span",G.$).each(function(){var N=E(this),M=N.html().replace(K,"<strong>$1</strong>");N.html(M)})};var C=function(G){AJS.log("InputDrivenDropDown: add space names");E("a span:not(.icon)",G.$).each(function(){var J=E(this);var H;try{H=AJS.dropDown.getAdditionalPropertyValue(J,"spaceName")}catch(I){AJS.log("Problem getting space name: "+I.message)}var K=J.text();if(H){K+=" ("+AJS("i").html(H).text()+")"}J.attr("title",K)})};var F=function(K,H){var J=K.options,I=K.dd;if(I){I.hide();I.$.remove()}J.ajsDropDownOptions=J.ajsDropDownOptions||{};if(J.ajsDropDownOptions&&!J.ajsDropDownOptions.alignment){J.ajsDropDownOptions.alignment="left"}J.ajsDropDownOptions.selectionHandler=J.ajsDropDownOptions.selectionHandler||function(M,L){if(M.type!="click"){M.preventDefault();E("a",L).click();document.location=E("a",L).attr("href")}};var G=K.dd=AJS.dropDown(H.matrix,J.ajsDropDownOptions)[0];if(J.ajsDropDownOptions&&J.ajsDropDownOptions.className){G.$.addClass(J.ajsDropDownOptions.className)}if(J.dropdownPlacement){J.dropdownPlacement(G.$)}else{AJS.log("No dropdownPlacement function specified. Appending dropdown to the body.");E("body").append(G.$)}B(G,H.queryTokens||[H.query]);D(G);C(G);if(J.dropdownPostprocess){J.dropdownPostprocess(G.$)}G.show(K._effect);if(typeof J.onShow=="function"){J.onShow.call(G,G.$)}return G};function A(H,G){this._effect="appear";this._timer=null;this.id=H;this.options=G;this.inactive=false;this.busy=false;this.cacheManager=AJS.Confluence.cacheManager()}A.prototype.clearCache=function(){this.cacheManager.clear()};A.prototype.change=function(I,H){var G=this;if(I!=G._value){G._value=I;G.busy=false;clearTimeout(G._timer);if(H||(/\S{2,}/).test(I)){var J=G.cacheManager.get(I);if(J){F(G,J)}else{G.busy=true;G._timer=setTimeout(function(){G.options.getDataAndRunCallback.call(G,I,G.show)},200)}}else{G.dd&&G.dd.hide()}}};A.prototype.hide=function(){this.dd&&this.dd.hide()};A.prototype.remove=function(){var G=this.dd;if(G){this.hide();G.$.remove()}this.inactive=true;this.options.onDeath&&this.options.onDeath()};A.prototype.show=function(H,J,I){if(this.inactive){AJS.log("Quick search abandoned before server response received, ignoring. "+this);return }var G={matrix:H,query:J,queryTokens:I};this.cacheManager.put(J,G);F(this,G);this.busy=false};AJS.inputDrivenDropdown=function(G){return new A("inputdriven-dropdown",G)}})(jQuery);