jQuery.fn.sizeToFit=function(){var A=jQuery;this.each(function(){var D=this;var B=A(this).parent();var E=B.height();B.children().each(function(){if(this!=D){E-=A(this).outerHeight()}});var C=A(this).outerHeight()-A(this).height();A(this).css("height",Math.max(0,E-C)+"px")});return this};AJS.Editor.ImageDialog=AJS.Editor.ImageDialog||{beforeShowListeners:[],afterThumbnailsDisplayedListeners:[]};AJS.toInit(function(A){AJS.wikiAttrToString=function(B){var C=[];for(var D in B){if(B.hasOwnProperty(D)){C.push(typeof B[D]=="boolean"?B[D]?D:"":D+"="+B[D])}}return C.length?"|"+C.join(","):""};AJS.Editor.insertImageDialog=function(C,B){this.openImageDialog({submitCallback:C,cancelCallback:B})};AJS.Editor.openImageDialog=function(Q){Q=Q||{};var L=100,G=97;var I="",C=new AJS.Dialog(800,590,"insert-image-dialog");var D=AJS.params.attachmentSourceContentId;var H=function(U){var T={},V=A(".img-align",U).val(),R=!!A(".img-thumbnail",U).attr("checked"),S=!!A(".img-border",U).attr("checked");V!="none"&&(T.align=V);R&&(T.thumbnail=true);S&&(T.border="1");return T};function M(){C.hide().remove();A(document).unbind(".insert-image");Q.cancelCallback&&Q.cancelCallback()}A(document).bind("keydown.insert-image",function(R){if(R.which==27&&!A("#fancy_overlay").is(":visible")){M();return AJS.stopEvent(R)}});var B=AJS.I18n.getText(Q.imageProperties?"image.browser.edit.title":"image.browser.insert.title");var P=AJS.I18n.getText(Q.imageProperties?"image.browser.edit.button":"image.browser.insert.button");C.addHeader(B);C.addPanel(AJS.getTemplate("attachedTabTitle").toString(),AJS.renderTemplate("attachedImages",AJS.getTemplate("imagePropertiesForm")),"attachments-panel");C.addPanel(AJS.getTemplate("webImageTitle").toString(),AJS.renderTemplate("webImage",AJS.getTemplate("imagePropertiesForm")),"web-image-panel");C.addButton(P,function(R){var S=H(R.getCurrentPanel().body);R.remove();A(document).unbind(".insert-image");Q.submitCallback&&Q.submitCallback(I,S,D)});C.addButton(AJS.getTemplate("cancelButton").toString(),M);C.get("panel:0").setPadding(0);C.get("panel:1").setPadding(0);C.get("panel:0").select();var F=C.get("button:0")[0].item;F.attr("disabled","disabled");A("input.image-url",C.popup.element).bind("keyup click",function(R){var S=A(this).val();I=S;F.attr("disabled",(S!=""&&S!="http://"?"":"disabled"));if(R.which==13){A("input.image-preview",C.popup.element).click();C.get("button:0")[0].item.focus()}});A("input.image-preview",C.popup.element).click(function(){var R=A(this).closest("div");var W=R.find("input.image-url").val();var V=R.find(".image-preview-area");var U=R.find(".image-preview-throbber");U.removeClass("hidden");var T=Raphael.spinner(U[0],60,"#666");var S=R.find(".image-preview-error");V.addClass("faraway");S.addClass("hidden");V.html("");A("<img>").load(function(){T();U.addClass("hidden");V.removeClass("faraway")}).error(function(){T();U.addClass("hidden");S.removeClass("hidden")}).appendTo(V).attr("src",W)});if(Q.imageProperties){A(".img-align",C.popup.element).val(Q.imageProperties.align||"none");A(".img-thumbnail",C.popup.element).attr("checked",Q.imageProperties.thumbnail||"");A(".img-border",C.popup.element).attr("checked",!!Q.imageProperties.border||"");if(Q.imageProperties.url){C.get("panel:1").select();A("input.image-url",C.popup.element).val(Q.imageProperties.url).click();A("input.image-preview",C.popup.element).click()}}AJS.log(AJS.Editor.ImageDialog.beforeShowListeners.length+" beforeShow listeners registered.");A.each(AJS.Editor.ImageDialog.beforeShowListeners,function(){this()});C.show();C.popup.element.find(".dialog-button-panel").append(AJS.renderTemplate("insert-image-help-link"));A("select.img-align").focus();var O=A("#upload-attachment form");var K=A("#upload-attachment .image-uploading");var J=A("#upload-attachment .warning");var N=A("#attached-images");AJS.Editor.ImageDialog.clearErrors=function(){J.addClass("hidden");J.empty();N.sizeToFit()};AJS.Editor.ImageDialog.displayErrors=function(S){if(!S||!S.length){return }J.removeClass("hidden");var R=A("ul",J);if(!R.length){R=A("<ul></ul>");R.appendTo(J)}A.each(S,function(T,U){if(!U){return }A("<li>"+U.substring(0,Math.min(G,U.length))+(U.length>G?"&hellip;":"")+"</li>").attr("title",U).appendTo(R)});A("#attached-images").sizeToFit()};AJS.Editor.ImageDialog.imagesContainerSelector="#attached-images .image-list";O.ajaxForm({dataType:"json",data:{contentId:D,responseFormat:"html"},resetForm:true,beforeSubmit:function(){AJS.Editor.ImageDialog.setUploadInProgress(true);AJS.Editor.ImageDialog.clearErrors()},error:function(R){AJS.Editor.ImageDialog.setUploadInProgress(false);AJS.Editor.ImageDialog.displayErrors([AJS.params.imageUploadError]);AJS.log("Response from server was: "+R.responseText)},success:function(R){AJS.Editor.ImageDialog.setUploadInProgress(false);var S=[].concat(R.validationErrors||[]).concat(R.actionErrors||[]).concat(R.errorMessage||[]);if(S.length>0){AJS.Editor.ImageDialog.displayErrors(S);return }AJS.Editor.ImageDialog.refreshWithLatestImages(A.map(R.attachmentsAdded||[],function(T){return T.name}))}});O.find("input:file").change(function(){O.submit()});function E(S){if(Math.max(S.thumbnailWidth,S.thumbnailHeight)>L){if(S.thumbnailHeight>S.thumbnailWidth){S.thumbnailWidth=S.thumbnailWidth*L/S.thumbnailHeight;S.thumbnailHeight=L}else{S.thumbnailHeight=S.thumbnailHeight*L/S.thumbnailWidth;S.thumbnailWidth=L}}var T=S.thumbnailUrl+(S.thumbnailUrl.indexOf("?")+1?"&":"?")+"nonce="+(+new Date);var R=A(AJS.renderTemplate("imageDialogImage",T,S.thumbnailWidth,S.thumbnailHeight,(100-S.thumbnailHeight)/2,S.downloadUrl,S.name));R.find(".image-container").andSelf().hover(function(){A(this).addClass("hover")},function(){A(this).removeClass("hover")});R.find("img").load(function(){R.find(".image-container").removeClass("loading")});R.click(function(U){A("#attached-images .selected").removeClass("selected");R.addClass("selected").focus();I=this.name=this.name||A(".caption",this).text();F.attr("disabled","");return AJS.stopEvent(U)});R.dblclick(function(){A(this).click();F.click()});A(".zoom",R).fancybox({padding:0,zoomSpeedIn:500,zoomSpeedOut:500,overlayShow:true,overlayOpacity:0.5});return R}A(document).bind("keydown.insert-image",function(S){if(!N.is(":visible")){return }if(A("#fancy_overlay").is(":visible")){if(S.which==32){A("#fancy_close").click();S.preventDefault();S.stopPropagation();return false}}else{function R(X){var U=A(".attached-image",N);var W=A(".attached-image.selected",N);var T=U.index(W)+X;if(T<0){T=U.length-1}if(T>=U.length){T=0}var V=U.eq(T);V.click().focus();N.simpleScrollTo(V)}if(S.which==37){R(-1);return AJS.stopEvent(S)}else{if(S.which==38){R(-4);return AJS.stopEvent(S)}else{if(S.which==39){R(1);return AJS.stopEvent(S)}else{if(S.which==40){R(4);return AJS.stopEvent(S)}else{if(S.which==32&&A(".attached-image.selected").length>0){A(".attached-image.selected .zoom").click();return AJS.stopEvent(S)}else{if(S.which==13&&!F.is(":disabled")){F.click();return AJS.stopEvent(S)}}}}}}}});AJS.Editor.ImageDialog.setUploadInProgress=function(R,S){if(R){O.addClass("hidden");K.removeClass("hidden");S?K.html(S):K.html(AJS.renderTemplate("imageUploading"))}else{O.removeClass("hidden");K.addClass("hidden")}};AJS.Editor.ImageDialog.refreshWithLatestImages=function(R){R=A.map(R||[],function(S){return S&&S.toLowerCase()});A.ajax({type:"GET",url:AJS.params.contextPath+"/pages/attachedimages.action",dataType:"json",data:{contentId:D},error:function(){N.find(".loading-message").remove();N.append(AJS.renderTemplate("imageDialogErrorRetrievingAttachments"))},success:function(S){N.find(".loading-message").remove();N.find(".image-list").empty();N.find(".no-attachments").remove();A(S.images||[]).each(function(){if(this.name&&A.inArray(this.name.toLowerCase(),R)!=-1){N.find(".image-list").prepend(E(this))}else{N.find(".image-list").append(E(this))}});if(N.find(".image-list li").length==0){N.append(AJS.renderTemplate("imageDialogNoAttachments"))}N.sizeToFit().click(function(){I=null;F.attr("disabled","disabled");A(this).find(".selected").removeClass("selected")});if(R.length){N.find(".image-list li:first").click()}else{if(Q.imageProperties&&Q.imageProperties.imageFileName){N.find("img[src*=/"+Q.imageProperties.imageFileName+"?]").click()}}AJS.log(AJS.Editor.ImageDialog.afterThumbnailsDisplayedListeners.length+" afterThumbnailsDisplayed listeners registered.");A.each(AJS.Editor.ImageDialog.afterThumbnailsDisplayedListeners,function(){this()});var U=[];var T=A.map(S.images||[],function(V){return V.name&&V.name.toLowerCase()});A.each(R,function(V,W){A.inArray(W,T)==-1&&U.push(AJS.renderTemplate("imageNotThumbnailable",W))});U&&AJS.Editor.ImageDialog.displayErrors(U)}})};AJS.Editor.ImageDialog.refreshWithLatestImages()};A("#editor-insert-image").click(function(C){AJS.Editor.storeTextareaBits();var B=document.getElementById("markupTextarea");AJS.Editor.insertImageDialog(function(D,E){AJS.Editor.Markup.insertOrUpdateText(AJS.format("\n!{0}{1}!\n",D,AJS.wikiAttrToString(E)),B)});return AJS.stopEvent(C)})});