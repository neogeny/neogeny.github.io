AJS.PagePermissions=AJS.PagePermissions||{};AJS.$.fn.disable=function(A){return this.each(function(){var B=AJS.$(this);var C=B.attr("disabled","disabled").addClass("disabled").attr("id");if(C){AJS.$("label[for="+C+"]",B.parent()).addClass("disabled")}})};AJS.$.fn.enable=function(A){return this.each(function(){var B=AJS.$(this);var C=B.attr("disabled","").removeClass("disabled").attr("id");if(C){AJS.$("label[for="+C+"]",B.parent()).removeClass("disabled")}})};AJS.toInit(function(D){var G="user",R="group";var J=D("#confluence-context-path").attr("content");var N=!!D("#permissions-show-hide-link").length;var A=null;var K=null;var Q=null;var M={addNames:function(T,V){var U=this;var S=T.replace(/\s*,\s*/g,",").split(",");var W=D("#waitImage");W.show();var X={name:S,type:V||"",pageId:AJS.params.parentPageId,spaceKey:AJS.params.spaceKeyDecoded};D.getJSON(J+"/pages/getentities.action",X,function(d){W.hide();for(var c=0,Y=d.length;c<Y;c++){var a=d[c].entity;var Z=d[c].report;U.addEntity(d[c]);var b=D.inArray(a.name,S);S.splice(b,1)}K.validator.handleNonExistentEntityNames(S)})},addEntity:function(U){if(!U){return }var T=U.entity;var S=U.report;var W=K.getPermissionType();if(K.validator.isDuplicateEntityForType(T,W)){Q.highlightEntityRow(T,W);return }var V={entity:T,view:true,edit:true,report:S};Q.addRow(V,W);Q.changedByUser();Q.highlightEntityRow(T,W);K.nameField.removeFromNameInput(T.name)},makePermissionStrings:function(){var S=Q.makePermissionMap(false);return{viewPermissionsUsers:S.user.view.join(","),editPermissionsUsers:S.user.edit.join(","),viewPermissionsGroups:S.group.view.join(","),editPermissionsGroups:S.group.edit.join(",")}},refreshLayout:function(){var X=D("#page-permissions-tables");var W=D("#update-page-restrictions-dialog");var U=W.outerHeight();var S=W.find("h2").outerHeight();var Z=W.find(".dialog-button-panel").outerHeight();var V=U-(S+Z);var Y=D("#page-permissions-editor-form").outerHeight();var T=V-Y;D("#update-page-restrictions-dialog .dialog-panel-body").height(V);X.height(T)}};D.extend(AJS.PagePermissions,{addUserPermissions:function(S){M.addNames(S,G)},addGroupPermissions:function(S){M.addNames(S,R)},makePermissionStrings:M.makePermissionStrings});function E(U){Q.allowEditing(U.userCanEditRestrictions);Q.resetInherited();if(!M.permissionsEdited){Q.resetDirect()}if(!U){return }for(var V=0,X=U.permissions.length;V<X;V++){var d=U.permissions[V];var Z=d[0].toLowerCase();var S=d[1];var b=d[2];var T=(S==G)?U.users[b]:U.groups[b];var c=d[3];var a=d[4];var W=+c&&c!=AJS.params.pageId;if(M.permissionsEdited&&!W){continue}var Y={owningId:c,entity:T.entity,report:T.report};Y[Z]=true;Y.owningTitle=a;Y.inherited=W;Q.addRow(Y,Z)}Q.saveBackup();Q.refresh()}function H(){var Z=Q.makePermissionMap(true);var T=D("#permissions-view-summary");var X=[].concat(Z.group.view).concat(Z.user.view);if(X.length){T.find(".summary-content").text(X.join(", "))}AJS.setVisible(T,X.length);var V=D("#permissions-edit-summary");var S=[].concat(Z.group.edit).concat(Z.user.edit);if(S.length){V.find(".summary-content").text(S.join(", "))}AJS.setVisible(V,S.length);M.permissionsEdited=false;var Y=M.makePermissionStrings();for(var U in Y){var W=Y[U];D("#"+U).val(W);if(M.originalPermissions[U]!=W){M.permissionsEdited=true}}}function P(){K.validator.resetValidationErrors();Q.clearHighlight();A.hide();window.scrollTo(M.bookmark.scrollX,M.bookmark.scrollY)}function F(){var T=D(".permissions-update-button").disable();if(N){H();AJS.setVisible("#page-permissions-unsaved-changes-msg",M.permissionsEdited);T.enable();P()}else{var S=M.makePermissionStrings();S.pageId=AJS.params.pageId;D("#waitImage").show();AJS.safe.post(J+"/pages/setpagepermissions.action",S,function(U){D("#waitImage").hide();AJS.setVisible("#content-metadata-page-restrictions",U.hasPermissions);T.enable();P()},"json")}}function C(){P();if(N){Q.restoreBackup()}}function O(){if(A){return }A=AJS.ConfluenceDialog({width:865,height:530,id:"update-page-restrictions-dialog",onCancel:C});A.addHeader(AJS.I18n.getText("page.perms.dialog.heading"));A.addPanel("Page Permissions Editor",AJS.renderTemplate("page-permissions-div"));A.addButton(AJS.params.statusDialogUpdateButtonLabel||AJS.I18n.getText("update.name"),F,"permissions-update-button");A.addButton(AJS.params.statusDialogCancelButtonLabel||AJS.I18n.getText("cancel.name"),C,"permissions-cancel-button");A.popup.element.find(".dialog-button-panel").append(AJS.renderTemplate("page-restrictions-help-link"));K=AJS.PagePermissions.Controls(M);Q=AJS.PagePermissions.Table(D("#page-permissions-table"));M.table=Q}function I(T){M.bookmark={scrollX:document.documentElement.scrollLeft,scrollY:document.documentElement.scrollTop};D(".permissions-update-button").disable();K.setVisible(T.userCanEditRestrictions);var S=AJS.I18n.getText(T.userCanEditRestrictions?"cancel.name":"close.name");D(".permissions-cancel-button").text(S);AJS.setVisible(".permissions-update-button",T.userCanEditRestrictions);A.show();M.refreshLayout()}function B(W,T){var U=(T&&D("#newSpaceKey").val())||AJS.params.spaceKeyDecoded;var S=(T&&D("#parentPageString").val())||"";var V={pageId:AJS.params.pageId,parentPageId:AJS.params.parentPageId,parentPageTitle:S,spaceKey:U};if(AJS.params.newPage){V.draftId=AJS.params.contentId}D("#waitImage").show();D.getJSON(J+"/pages/getpagepermissions.action",V,function(X){D("#waitImage").hide();E(X);W(X)})}function L(S){O();B(I,S)}D("#content-metadata-page-restrictions, #action-page-permissions-link").click(function(S){L(false);S.preventDefault()});D("#permissions-show-hide-link").click(function(S){L(true);S.preventDefault()});if(N){M.originalPermissions={viewPermissionsUsers:D("#viewPermissionsUsers").val(),editPermissionsUsers:D("#editPermissionsUsers").val(),viewPermissionsGroups:D("#viewPermissionsGroups").val(),editPermissionsGroups:D("#editPermissionsGroups").val()}}});