AJS.MacroBrowser=(function(B){var A={};return{hasInit:false,metadataList:[],aliasMap:{},fields:{},Macros:A,getMacroJsOverride:function(C){return A[C]},setMacroJsOverride:function(D,C){return A[D]=C},parseMacro:function(G){var E=G.match(/(\{(.+?)(?::(.*?(?=[^\\]\}).)?)?\})(?:((?:\n|.)*?)\{\2\})?/);var F={markup:E[0],startTag:E[1],name:E[2],paramStr:E[3],bodyMarkup:E[4],params:{}};if(F.markup){var C=G.split(F.markup);F.beforeTag=C[0];F.afterTag=C[1]}if(F.paramStr){var D=F.paramStr.split("|");B(D).each(function(I,J){var H=J.indexOf("=");if(H<0&&!F.params[""]){F.params[""]=J}else{F.params[J.substring(0,H)]=J.substring(H+1)}})}return F},getSelectedMacro:function(D,E){var C=/^(?:.|\n)*[^\\](?={(?:\\}|[^}])+$)/m.exec(" "+D+" ");if(!C){return null}var G=C[0].substring(1).length;var F=AJS.MacroBrowser.parseMacro(E.substring(G));F.startIndex=G;F.params={};if(F.paramStr){F.paramStr.replace(/(?=(?:^|\|)(.*?)(?:=(.*?))?(?:\||$))/g,function(H,I,J){if((!J||J=="")&&!F.params[""]){F.params[""]=I}else{F.params[I]=J}})}return F},makeParameterDiv:function(K,F,C){var N=this,M;var I=F.type.name;if(C){var H=C.fields&&C.fields[I];if(H&&typeof H!="function"){H=H[F.name]}if(typeof H=="function"){M=H.call(C,F)}}if(!M){if(!(I in N.ParameterFields&&typeof N.ParameterFields[I]=="function")){I="string"}M=N.ParameterFields[I](F)}N.fields[F.name]=M;var J=M.paramDiv;var L=M.input;var D="macro-param-"+F.name;J.attr("id","macro-param-div-"+F.name);L.addClass("macro-param-input").attr("id",D);if(F.hidden){J.hide()}var G=K.pluginKey;if(F.displayName==N.makeDefaultKey(G,K.macroName,"param",F.name,"label")){F.displayName=F.name}if(F.description==N.makeDefaultKey(G,K.macroName,"param",F.name,"desc")){F.description=""}var E=F.displayName;if(F.required){E+=" *";J.addClass("required")}B("label",J).attr("for",D).text(E);if(F.description){J.append(AJS.clone("#macro-param-desc-template").html(F.description))}return J},makeBodyDiv:function(C,D){var E=AJS.MacroBrowser;var F=AJS.clone("#macro-body-template");B("textarea",F).val((D&&D.bodyMarkup)||E.settings.selectedMarkup||"");if(C.label){B("label",F).text(C.label)}if(C.description){F.append(AJS.clone("#macro-param-desc-template").html(C.description))}if(C.hidden){F.hide()}return F},processRequiredParameters:function(){var C=B("#macro-insert-container .macro-param-div.required .macro-param-input").filter(function(){var G=B(this).val();return(G==null||G=="")});var F=(C.length==0);var E=F?"":"disabled";var D=E?"addClass":"removeClass";AJS.$("#macro-browser-dialog button.ok").attr("disabled",E);AJS.$("#macro-browser-dialog .macro-preview-header .refresh-link").attr("disabled",E)[D]("disabled");return F},paramChanged:function(){AJS.MacroBrowser.processRequiredParameters()},loadMacroInBrowser:function(M,P){if(!M||!M.formDetails){alert(AJS.params.unknownMacroMessage);return }var O=AJS.MacroBrowser,W=M.formDetails,D=W.macroName,C=A[D],S=O.settings.selectedMacro,T=P=="edit"?O.editTitle:O.insertTitle;B("#save-warning-span").addClass("hidden");AJS.MacroBrowser.dialog.gotoPage(1).addHeader(T.replace(/\{0\}/,M.title));var Y=AJS.$("#macro-browser-dialog .dialog-button-panel .ok");if(P=="edit"){Y.text(AJS.params.saveButtonLabel)}else{Y.text(AJS.params.insertButtonLabel)}AJS.$("#macro-insert-container .macro-name").val(D);var K=M.extendedDescription?M.extendedDescription:M.description;var Z=AJS.clone("#macro-summary-template .macro-desc").prepend(K),N=B("#macro-insert-container .macro-input-fields").html(Z);if(W.documentationUrl){var Q=AJS.clone("#macro-doco-link-template");AJS.$("a",Q).attr("href",W.documentationUrl);Z.append(Q)}else{if(!Z.text()){Z.remove()}}if(W.body){var H=M.pluginKey;if(W.body.label==O.makeDefaultKey(H,D,"body","label")){W.body.label=""}if(W.body.description==O.makeDefaultKey(H,D,"body","desc")){W.body.description=""}var L=O.makeBodyDiv(W.body,S)}if(W.freeform){var E=(S&&S.paramStr)||"",J=AJS.clone("#macro-freeform-template");B(".macro-name-display",J).text(D+": ");B(".macro-text",J).val(E);if(L){L=L.append("{"+D+"}");AJS.$(".macro-freeform-input",J).after(L)}if(W.notationHelp){var X=AJS.$(W.notationHelp).children();if(X[0]){if(!S){var U=AJS.$(X[0]).html().replace(/<br>/gi,"\n").replace(/<[^>]+>/gi,"");var I=U.indexOf("{"+D);if(I>-1){var V=O.parseMacro(U.substring(I));if(V.paramStr){B(".macro-freeform-input input",J).val(V.paramStr)}if(V.bodyMarkup){B(".macro-body-div textarea",J).val(V.bodyMarkup.replace(/^\n|\n$/g,"").replace(/^\s+|\s+$/gm,""))}}}B(".macro-example",J).append(X[0].innerHTML).removeClass("hidden")}if(X[1]){B(".macro-help",J).append(X[1].innerHTML).removeClass("hidden")}}N.append(J)}else{if(L){N.append(L)}B(W.parameters).each(function(){N.append(O.makeParameterDiv(M,this,C))});var R=S?B.extend({},S.params):{};if(C&&typeof C.beforeParamsSet=="function"){R=C.beforeParamsSet(R,!S)}var G={};if(C&&typeof C.populateBodyParams=="function"){G=C.populateBodyParams(L)}B(W.parameters).each(function(){var b=this,a=R[b.name];if(a!=null){delete R[b.name]}else{B(b.aliases).each(function(){if(R[this]){a=R[this];delete R[this]}})}if(a==null){if(G[b.name]){a=G[b.name]}else{a=b.defaultValue}}if(a!=null){O.fields[b.name].setValue(a)}});O.unknownParams=R}B("a",N).click(function(){window.open(this.href,"_blank").focus();return false});if(!B("#macro-browser-dialog:visible").length){O.showBrowserDialog()}var F=B(":input:visible:first",N);if(F.length){F.focus();if(!S&&F.val()!=""&&F[0].select){F[0].select()}}O.previewMacro(M)},makeParamStringFromMap:function(C){var D=[];if(C[""]){D.push(C[""]);delete C[""]}for(var E in C){D.push(E+"="+C[E])}return D.join("|")},getMacroMarkupFromForm:function(J){var D=B("#macro-insert-container .macro-name").val(),L="{"+D,M=B("#macro-insert-container .macro-text"),E,N=AJS.MacroBrowser;if(M.length){E=M.val()}else{var I={},F={},H=J.formDetails.parameters;B(H).each(function(){var O=AJS.$("#macro-param-"+this.name);var P=O.val();if(O.attr("type")=="checkbox"){P=""+O.attr("checked")}if(this.forBody){if(P){F[this.name]=P}}else{if(P&&(this.hidden||(!this.defaultValue||this.defaultValue!=P))){I[this.name]=P}}});if(N.unknownParams){B.each(N.unknownParams,function(O,P){I[O]=P})}var C=A[D];if(C&&typeof C.beforeParamsRetrieved=="function"){I=C.beforeParamsRetrieved(I)}E=N.makeParamStringFromMap(I)}if(E){L+=":"+E}L+="}";var G={name:D,startTag:L,markup:L,bodyMarkup:"",hasBody:AJS.$("#macro-insert-container .macro-body-div").length>0};if(G.hasBody){var K=AJS.$("#macro-insert-container .macro-body-div textarea").val();C=A[D];if(C&&C.applySpecialBodyHandling){K=C.applySpecialBodyHandling(J,K,F)}G.bodyMarkup=K;G.markup+=G.bodyMarkup;G.markup+="{"+D+"}"}return G},previewMacro:function(E){var D=AJS.MacroBrowser;B("#macro-insert-container .macro-preview").html("");if(!D.processRequiredParameters()){AJS.log("previewMacro: missing required params");return }AJS.log("previewMacro: required params ok");D.showPreviewWaitImage(true);var G=D.getMacroMarkupFromForm(E).markup,C=A[E.macroName];if(C&&C.prepareMacroForPreview){G=C.prepareMacroForPreview(G)}var F={contentId:AJS.Editor.getContentId(),contentType:AJS.params.contentType,spaceKey:AJS.params.spaceKey,wikiMarkup:G};B.post(AJS.params.contextPath+"/pages/rendercontent.action",F,function(H){AJS.MacroBrowser.showPreviewWaitImage(false);var M=AJS.params.staticResourceUrlPrefix+"/blank.html";var L=AJS.$("#macro-insert-container .macro-preview");L.html('<iframe src="'+M+'" frameborder="0" name="macro-browser-preview-frame" id="macro-preview-iframe"></iframe>');AJS.log("previewMacro: Created iframe");var I=AJS.$("#macro-insert-container .macro-preview iframe")[0];var K=I.contentDocument||I.contentWindow.document;K.write(H);K.close();var J=B("div.error span.error",K);if(J.length){AJS.log("Error rendering markup : "+G)}AJS.log("previewMacro: rendered")})},showPreviewWaitImage:function(C){if(C){B("#macro-browser-preview-link").attr("disabled",true).addClass("disabled");var D=AJS("div").addClass("macro-loading");B("#macro-browser-preview").append(D);AJS.MacroBrowser.previewSpinner=Raphael.spinner(D[0],60,"#666");AJS.MacroBrowser.previewSpinner.throbber=D}else{if(AJS.MacroBrowser.previewSpinner){B("#macro-browser-preview").removeClass("macro-loading");AJS.MacroBrowser.previewSpinner();AJS.MacroBrowser.previewSpinner.throbber.remove();delete AJS.MacroBrowser.previewSpinner;B("#macro-browser-preview-link").attr("disabled",false).removeClass("disabled")}}},previewOnload:function(C){var E=AJS.MacroBrowser.dialog.activeMetadata.macroName;var D=A[E];if(D&&D.postPreview){D.postPreview(AJS.$("#macro-preview-iframe")[0],AJS.MacroBrowser.dialog.activeMetadata)}AJS.Editor.disableFrame(C);B(C).click(function(H){if(H.target.tagName.toLowerCase()==="a"){var F=H.target;var G=B(F).attr("href");if(G&&G.indexOf("#")!=0&&G.indexOf(window.location)==-1){window.open(G,"_blank").focus()}return false}})},getMacroMetadata:function(F){for(var E=0,C=this.metadataList.length;E<C;E++){var D=this.metadataList[E];if(D.macroName==F){return D}}return null},open:function(D){if(!D){D={};AJS.log("No settings to open the macro browser.")}var C=AJS.MacroBrowser;if(!C.hasInit){AJS.log("init macro browser");C.showBrowserSpinner(true);if(C.initData){C.initBrowser()}else{C.initMacroBrowserAfterRequest=D;return }}C.openMacroBrowser(D)},openMacroBrowser:function(D){var J=AJS.MacroBrowser;J.settings=D;if(D.presetMacroName){D.presetMacroMetadata=J.getMacroMetadata(D.presetMacroName)}var F=D.presetMacroMetadata;if(!F){var K=D.selectedMacro;if(K){var E=K.name.toLowerCase();E=J.aliasMap[E]||E;var C=A[E];if(C){if(typeof C.updateSelectedMacro=="function"){C.updateSelectedMacro(K)}var I=C.getMacroDetailsFromSelectedMacro;if(I){F=I(J.metadataList,K)}}if(!F){F=AJS.MacroBrowser.getMacroMetadata(E)}}}if(F){AJS.log("Open macro browser to edit macro: "+F.macroName);B("#macro-browser-dialog button.back").hide();J.replicateSelectMacro(F,D.mode||"edit")}else{B("#macro-browser-dialog button.back").show();J.showBrowserDialog();J.dialog.gotoPanel(0,0);var H=B.trim(D.searchText);var G=B("#macro-browser-search");G.val(H).keyup();H&&G.removeClass("blank-search");G.focus()}},showBrowserDialog:function(){AJS.MacroBrowser.dialog.show();AJS.MacroBrowser.showBrowserSpinner(false)},complete:function(G){if(!B("#macro-browser-dialog .dialog-button-panel .ok").is(":visible:not(:disabled)")){return }var F=AJS.MacroBrowser;var E=F.dialog.activeMetadata;var C=A[E.macroName];if(C&&C.manipulateMarkup){C.manipulateMarkup(E)}var D=F.getMacroMarkupFromForm(E);F.close();if(F.settings.onComplete){F.settings.onComplete(D)}},cancel:function(){var C=AJS.MacroBrowser;C.close();if(typeof C.settings.onCancel=="function"){C.settings.onCancel()}},close:function(){var C=this;C.unknownParams={};C.fields={};C.dialog.hide()},replicateSelectMacro:function(C,D){AJS.MacroBrowser.dialog.activeMetadata=C;AJS.MacroBrowser.loadMacroInBrowser(C,D)},makeDefaultKey:function(){return B.makeArray(arguments).join(".")},showBrowserSpinner:function(C){var D=AJS.Editor.inRichTextMode()?".defaultSkin span.mce_conf_macro_browser":"#editor-insert-macro";if(C){B(D).addClass("wait")}else{B(D).removeClass("wait")}},initBrowser:function(){var O=AJS.MacroBrowser,V=O.initData;if(!V.categories||!AJS.MacroBrowser.metadataList.length){alert(AJS.params.loadBrowserErrorMessage);AJS.MacroBrowser.showBrowserSpinner(false);return false}var P=new Date();var T=O.dialog=AJS.ConfluenceDialog({width:865,height:530,id:"macro-browser-dialog",onSubmit:O.complete,onCancel:O.cancel});T.addHeader(V.title);O.editTitle=V.editTitle;O.insertTitle=V.insertTitle;V.categories.sort(function(X,W){return(X.displayName.toLowerCase()>W.displayName.toLowerCase()?1:-1)});var D=function(W){return B("#macro-summaries-template").clone().attr("id","category-"+W)};var J=function(W){var X=AJS.clone("#macro-summary-template").click(function(Z){if(O.settings.nestingMacros&&(B.inArray(W.macroName,O.settings.nestingMacros)>-1)){alert(AJS.params.nestingSameMacroNotAllowedMessage);return AJS.stopEvent(Z)}T.activeMetadata=W;AJS.MacroBrowser.loadMacroInBrowser(W,"insert")});if(W.icon){var Y=(W.icon.relative?AJS.params.staticResourceUrlPrefix:"")+W.icon.location;if(!W.icon.relative&&AJS.$.browser.msie&&!window.location.href.indexOf("https")&&Y.indexOf("https")){X.prepend("<span class='macro-icon-holder icon-"+W.macroName+"'></span>")}else{X.prepend("<img src='"+Y+"' alt='icon' width='"+W.icon.width+"' height='"+W.icon.height+"' title='"+W.title+"'/>")}}else{X.prepend("<span class='macro-icon-holder icon-"+W.macroName+"'></span>")}B(".macro-title",X).text(W.title);B(".macro-desc",X).prepend(W.description);return X};var E={all:D("all")},S,K,R,U;for(S=0,K=O.metadataList.length;S<K;S++){var L=O.metadataList[S];if(!L.hidden){var N=J(L).attr("id",L.id);E.all.append(N);for(R=0,U=L.categories.length;R<U;R++){var M=L.categories[R];E[M]=E[M]||D(M);E[M].append(J(L).attr("id",M+"-"+L.id))}}}T.addPanel(AJS.params.categoryAllLabel,E.all);for(S=0,K=V.categories.length;S<K;S++){var Q=V.categories[S];T.addPanel(Q.displayName,E[Q.name]||D(Q.name),Q.name).getPanel(S).setPadding(0)}T.addButton(AJS.params.cancelButtonLabel,function(){AJS.MacroBrowser.cancel()},"cancel");T.popup.element.find(".dialog-button-panel").append(AJS.renderTemplate("macro-browser-help-link"));var F=AJS.$("#macro-insert-template").clone().attr("id","macro-insert-container");B(".macro-preview-container .macro-preview",F).attr("id","macro-browser-preview");B(".macro-preview-container .macro-preview-header .refresh-link",F).attr("id","macro-browser-preview-link").click(function(W){AJS.MacroBrowser.previewMacro(T.activeMetadata);return AJS.stopEvent(W)});T.addPage().addPanel("X",F,"macro-input-panel").addButton(AJS.params.backButtonLabel,function(W){W.prevPage();B("#macro-browser-search").focus()},"back left").addButton(AJS.params.insertButtonLabel,function(){AJS.MacroBrowser.complete()},"ok").addButton(AJS.params.cancelButtonLabel,function(){AJS.MacroBrowser.cancel()},"cancel").getPanel(0).setPadding(0);B("#macro-browser-dialog .dialog-button-panel .ok").before("<span id='save-warning-span' class='hidden'/>");var G=function(Y){var X=null;if(Y!=""){if(T.getCurrentPanel()!=T.getPanel(0)){T.gotoPanel(0)}var W=O.searchSummaries(Y);X={};B.each(W,function(){X[this.id]=this})}B("#macro-browser-dialog .dialog-panel-body #category-all .macro-list-item").each(function(){(!X||this.id in X)?B(this).show():B(this).hide()})};var H=B("<form id='macro-browser-search-form'><input type='text'/></form>");var C=B("input",H).attr("id","macro-browser-search").keyup(function(W){G(B.trim(C.val()))}).focus(function(X){var W=B(X.target);if(W.hasClass("blank-search")){W.removeClass("blank-search").val("")}X.target.select()}).blur(function(X){var W=B(X.target);if(B.trim(W.val())==""){W.addClass("blank-search").val(AJS.params.blankSearchText)}}).blur();H.submit(function(X){var W=B("#macro-browser-dialog .dialog-panel-body #category-all .macro-list-item:visible");if(B.trim(C.val())!=""&&W.length==1){W.click()}return AJS.stopEvent(X)});T.page[0].header.prepend(H);T.page[0].ontabchange=function(W,X){if(W!=T.getPanel(0,0)){if(!C.hasClass("blank-search")){C.val("").blur()}G("")}};T.gotoPanel(0,0);T.ready=true;O.hasInit=true;var I=(new Date()).getTime()-P.getTime();AJS.log("loading macro browser took "+I+"ms");return true},loadModel:function(C){if(!C){AJS.log("AJS.MacroBrowser.loadModel - no macro data, aborting");return }AJS.log("AJS.MacroBrowser.loadModel - starting");var K=AJS.MacroBrowser;K.metadataList=[];K.aliasMap={};for(var E=0,J=C.length;E<J;E++){var I=C[E];for(var D=0,F=I.aliases.length;D<F;D++){I.aliases[D]=I.aliases[D].toLowerCase();K.aliasMap[I.aliases[D]]=I.macroName.toLowerCase()}if(I.title==K.makeDefaultKey(I.pluginKey,I.macroName,"label")){I.title=I.macroName.charAt(0).toUpperCase()+I.macroName.substring(1).replace(/-/g," ")}if(I.description==K.makeDefaultKey(I.pluginKey,I.macroName,"desc")){I.description=""}I.id="macro-"+(I.alternateId||I.macroName);var G=[I.macroName,I.title].concat(I.aliases);I.keywordsNoDesc=G.join(",");var H=(I.description&&I.description.replace(/,/g," "))||"";G.push(H);I.keywords=G.join(",");K.metadataList.push(I)}K.metadataList.sort(function(M,L){return(M.title.toLowerCase()>L.title.toLowerCase()?1:-1)});AJS.log("AJS.MacroBrowser.loadModel - complete, "+K.metadataList.length+" macros loaded")},searchSummaries:function(D,C){C=B.extend({splitRegex:/[\s\-]+/},C);return AJS.filterBySearch(this.metadataList,D,C)}}})(AJS.$);AJS.toInit(function(A){A(window).bind("render-content-loaded",function(D,B){var C=A("#macro-preview-iframe");if(C.contents().find("body")[0]==B){AJS.MacroBrowser.previewOnload(B)}});setTimeout(function(){var B=AJS.MacroBrowser;AJS.$.ajax({type:"GET",dataType:"json",url:AJS.params.contextPath+"/plugins/macrobrowser/browse-macros.action",success:function(C){B.initData=C;B.loadModel(C.macros);if(B.initMacroBrowserAfterRequest){B.initBrowser();B.openMacroBrowser(B.initMacroBrowserAfterRequest)}},error:function(C){AJS.log("Error requesting macro browser metadata:");AJS.log(C);B.initData={}}})},500)});