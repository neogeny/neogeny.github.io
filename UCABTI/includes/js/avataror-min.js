(function(A){A(function(){A(".avataror").each(function(){var C=A(this);var D=A("img",this).attr("src");C.css({"-moz-border-radius":"10px","-webkit-border-radius":"10px"});C.html("<p>Loadingâ€¦</p>");var B={previewSize:64};B.preview=A("<div/>").css({border:"solid 1px #000","float":"left",height:"64px",overflow:"hidden",width:"64px",position:"relative",top:"-9999em",left:"-9999em"});C.append(B.preview);B.img=A('<img src="'+D+'" alt="Avatar Source"/>');B.img.load(function(){B.image=A("<div/>").css({background:"url('"+D+"') no-repeat",clear:"left",position:"relative"});B.marker=A("<div/>").css({cursor:"move",position:"relative"});B.dash=A("<div/>");B.shadow=A("<div/>");B.dash.add(B.shadow).css({cursor:"move",opacity:0.5,left:0,top:0,position:"absolute"});B.image.append(B.shadow).append(B.dash).append(B.marker);C.append(B.image);B.marker.html("<div></div><div></div><div></div><div></div>");A("div",B.marker).each(function(E){var F=A(this);F.css({background:"#000",border:"solid 1px #fff",width:"10px",height:"10px",position:"absolute","font-size":"1px"});F.css(["left","right","right","left"][E],"-6px");F.css(["top","top","bottom","bottom"][E],"-6px");F.css("cursor",["nw-resize","ne-resize","se-resize","sw-resize"][E]);F.mousedown(function(G){G.preventDefault();G.stopPropagation();B.dragging={x:G.pageX,y:G.pageY,ax:B.x,ay:B.y,w:B.width,h:B.height,i:E+1};B.shadow.hide()})});B.marker.add(B.image).mousedown(function(E){E.preventDefault();B.dragging={x:E.pageX,y:E.pageY,ax:B.x,ay:B.y,w:B.width,h:B.height};B.shadow.hide()}).mousemove(function(I){if(B.dragging){var G=I.pageX-B.dragging.x;var F=I.pageY-B.dragging.y;B.x=B.dragging.ax+G;B.y=B.dragging.ay+F;console.log([B.x,B.width,B.imgwidth]);console.log([B.y,B.height,B.imgheight]);if(B.x+B.width>B.imgwidth){B.x=B.imgwidth-B.width}if(B.y+B.height>B.imgheight){B.y=B.imgheight-B.height}if(B.x<0){B.x=0}if(B.y<0){B.y=0}var E;var H=[0,1,-1,-1,1];var J=[0,1,1,-1,-1];if(B.dragging.i){E=(Math.abs(G)<Math.abs(F)?J[B.dragging.i]*F:H[B.dragging.i]*G);B.width=B.height=B.dragging.w-E;if(B.width<20){B.width=B.height=20}B.x=B.dragging.ax+(B.dragging.w-B.width)*(1+H[B.dragging.i])/2;B.y=B.dragging.ay+(B.dragging.h-B.height)*(1+J[B.dragging.i])/2;if(B.x+B.width>B.imgwidth){B.width=B.height=B.imgwidth-B.x}if(B.y+B.height>B.imgheight){B.width=B.height=B.imgheight-B.y}}B.setMarker()}}).mouseup(function(E){A("#avatar-offsetX").val(B.x);A("#avatar-offsetY").val(B.y);A("#avatar-width").val(B.width);B.dragging=null;B.shadow.show()});B.imgwidth=B.img.width();B.imgheight=B.img.height();B.x=A("#avatar-offsetX").val()*1;B.y=A("#avatar-offsetY").val()*1;B.width=A("#avatar-width").val()*1;B.height=B.width;B.image.css({width:B.imgwidth+"px",height:B.imgheight+"px"});B.setMarker();C.css({width:B.imgwidth+"px"});B.preview.css({margin:"0 0 10px "+Math.round(B.imgwidth/2-B.previewSize/2)+"px",position:"static"});A("p",C).remove()});B.preview.append(B.img);B.setMarker=function(){this.marker.css("border","dashed 1px #fff");this.dash.css("border","solid 1px #000");this.shadow.css("border","solid 1px #000");this.marker.add(this.dash).css("left",this.x-1+"px");this.marker.add(this.dash).css("top",this.y-1+"px");this.shadow.css("border-left-width",this.x+"px");this.shadow.css("border-right-width",this.imgwidth-this.x-this.width+"px");this.shadow.css("border-top-width",this.y+"px");this.shadow.css("border-bottom-width",this.imgheight-this.y-this.height+"px");this.shadow.css("width",this.width+"px");this.shadow.css("height",this.height+"px");this.marker.add(this.dash).css("width",this.width+"px");this.marker.add(this.dash).css("height",this.height+"px");this.img.attr("width",this.imgwidth*this.previewSize/this.width);this.img.attr("height",this.imgheight*this.previewSize/this.height);this.img.css("margin-left","-"+this.x*this.previewSize/this.width+"px");this.img.css("margin-top","-"+this.y*this.previewSize/this.height+"px");this.preview.select()}})})})(jQuery);