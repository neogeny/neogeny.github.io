AJS.PagePermissions.Table=function(B){var D=AJS.$,C=this;var E=false;var A=false;this.refresh=function(){var I=B.find(".view-permission-row");var H=B.find(".edit-permission-row");var J=I.length>0;var G=H.length>0;AJS.setVisible("#page-permissions-no-views",!J);AJS.setVisible("#page-permissions-no-edits",!G);B.each(function(){D(".view-permission-row .page-permissions-marker-cell span",this).removeClass("first-of-type").filter(":first").addClass("first-of-type");D(".edit-permission-row .page-permissions-marker-cell span",this).removeClass("first-of-type").filter(":first").addClass("first-of-type")});C.clearHighlight()};this.saveBackup=function(){this.copy=B.children().clone(true)};this.restoreBackup=function(){B.children().remove();B.append(this.copy)};this.addCount=0;this.makePermissionMap=function(H){var G={user:{view:[],edit:[]},group:{view:[],edit:[]}};B.find("tr.view-permission-row, tr.edit-permission-row").each(function(){var M=D(this);var J=M.is(".user-permission")?"user":"group";var L=M.is(".view-permission-row")?"view":"edit";var K=(H&&(J=="user"))?"display-name":"name";var I=M.find(".permission-entity-"+K).text();G[J][L].push(I)});return G};this.makePermissionMapForCheckboxes=function(H){var G={user:{view:[],edit:[]},group:{view:[],edit:[]}};B.find("tr.view-permission-row").each(function(){var N=D(this);var J=!!N.find(".view-permission-cell input").attr("checked");var M=!!N.find(".edit-permission-cell input").attr("checked");if(J||M){var K=N.hasClass("user-permission")?"user":"group";var L=(H&&(K=="user"))?"display-name":"name";var I=N.find(".permission-entity-"+L).text();if(J&&(H||!N.hasClass("readonly-permission"))){G[K].view.push(I)}if(M){G[K].edit.push(I)}}});return G};var F=function(J,G){var I=J.find("td.permission-entity");var H=contextPath+(G.profilePictureDownloadPath||"/images/icons/"+G.type+"_16.gif");I.find("img").attr("src",H);I.find(".permission-entity-name").text(G.name);if(G.type=="group"){I.find(".permission-entity-name-wrap").hide()}I.find(".permission-entity-display-name").text(G.fullName||G.name);var K=I.find("span.entity-container");if(G.type=="user"){K.addClass("content-hover user-hover-trigger").attr("data-username",G.name)}};this.addRow=function(R,M){var J=R.entity;var I=D(AJS.renderTemplate("permissions-row-template"));I.addClass(J.type+"-permission");I.addClass(M+"-permission-row");if(M=="edit"){I.find(".page-permissions-marker-cell span").text(AJS.I18n.getText("page.perms.editing.restricted.to"))}F(I,J);var K=!A||R.inherited||R.readOnly;if(K){I.addClass("readonly-permission")}var N=I.find(".remove-permission-link");if(K||!A){N.remove()}else{N.attr("id","remove-permission-"+this.addCount++);N.click(function(T){D(this).closest("tr").remove();C.changedByUser();return AJS.stopEvent(T)})}if(R.inherited){var O=D(".page-permissions-table[owningTitle='"+AJS.escape(R.owningTitle)+"']");if(!O.length){var H=D(AJS.renderTemplate("page-inherited-permissions-table-div-template"));O=H.find("table");O.attr("owningTitle",AJS.escape(R.owningTitle));var L=H.find(".page-inherited-permissions-table-desc");var P=L.find("a"),G=AJS.Confluence.getContextPath()+"/pages/viewpage.action?pageId="+R.owningId;P.attr("href",G).attr("target","_blank").text(R.owningTitle).addClass("page-perms-owningTitle");var S=D("#content-title");var Q=S.length?S.val():AJS.params.pageTitle;L.find("span").addClass(".page-perms-inherited-this-page").text(Q);D("#page-inherited-permissions-tables").append(H)}O.append(I);D("#page-inherited-permissions-table-div").removeClass("hidden")}else{if(M=="view"){D("#page-permissions-no-edits").before(I)}else{B.append(I)}}AJS.Confluence.runBinderComponents()};this.changedByUser=function(){D(".permissions-update-button").attr("disabled","");C.clearHighlight();C.refresh()};this.resetDirect=function(){B.find("tr:not(.marker-row)").remove();C.addCount=0;if(E){var G={entity:{name:"",fullName:AJS.I18n.getText("page.perms.everyone.user"),type:"group"},readOnly:true,view:true,edit:true};this.addEntry(G)}};this.resetInherited=function(){D("#page-inherited-permissions-tables div").remove()};B.click(function(G){C.clearHighlight()});D("#page-inherited-permissions-table-desc").click(function(){D(".page-inheritance-togglable").toggleClass("hidden");D(".icon",this).toggleClass("twisty-open").toggleClass("twisty-closed")});this.highlightEntityRow=function(G,I){var H=B.find("."+I+"-permission-row").filter(function(){return D(".permission-entity-name",this).text()==G.name});D("#page-permissions-tables").simpleScrollTo(H);H.addClass("highlighted-permission")};this.clearHighlight=function(){D("tr.highlighted-permission").removeClass("highlighted-permission")};this.allowEditing=function(G){A=G};return this};